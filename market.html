<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time market data and price tracking for stocks, indices and more.">
    <title>Market Dashboard - Smart Investment Tips</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', sans-serif;
            background: #f8f9fa;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #0f0f1e;
            color: #e0e0e0;
        }
        
        nav {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        body.dark-mode nav {
            background: #1a1a2e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        nav .logo {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        body.dark-mode nav a {
            color: #e0e0e0;
        }
        
        nav a:hover {
            color: #667eea;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .dashboard-section {
            padding: 60px 20px;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .dashboard-header h1 {
            font-size: 42px;
            margin-bottom: 10px;
        }
        
        .dashboard-header p {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .markets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .market-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        body.dark-mode .market-card {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .market-card:hover {
            transform: translateY(-5px);
        }
        
        .market-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .market-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .market-price {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .market-change {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .change-positive {
            background: #d4edda;
            color: #155724;
        }
        
        .change-negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        body.dark-mode .change-positive {
            background: #2d5a3d;
            color: #90ee90;
        }
        
        body.dark-mode .change-negative {
            background: #5a2d2d;
            color: #ff6b6b;
        }
        
        .market-time {
            font-size: 12px;
            opacity: 0.6;
        }

        .market-source {
            margin-top: 8px;
            font-size: 11px;
            opacity: 0.7;
        }

        .board-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 12px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .board-link:hover {
            text-decoration: underline;
        }
        
        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        body.dark-mode .calendar-section {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .calendar-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .calendar-month {
            font-size: 14px;
            opacity: 0.8;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            border: 1px solid #e8ecf1;
            border-radius: 10px;
            overflow: hidden;
        }

        body.dark-mode .calendar-grid {
            border-color: #2f3348;
        }

        .calendar-day-head {
            padding: 10px 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            background: #f5f8fc;
            border-right: 1px solid #e8ecf1;
        }

        .calendar-day-head:last-child {
            border-right: none;
        }

        body.dark-mode .calendar-day-head {
            background: #20243a;
            border-right-color: #2f3348;
        }

        .calendar-cell {
            min-height: 120px;
            padding: 8px;
            border-top: 1px solid #e8ecf1;
            border-right: 1px solid #e8ecf1;
            background: #fff;
        }

        .calendar-cell:nth-child(7n) {
            border-right: none;
        }

        body.dark-mode .calendar-cell {
            background: #171a2d;
            border-top-color: #2f3348;
            border-right-color: #2f3348;
        }

        .calendar-cell.empty {
            background: #fafbfd;
        }

        body.dark-mode .calendar-cell.empty {
            background: #141729;
        }

        .calendar-day-num {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
            opacity: 0.85;
        }

        .event-item {
            font-size: 11px;
            line-height: 1.35;
            border-radius: 6px;
            padding: 4px 6px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .event-high {
            background: #ffe5e5;
            color: #8b1c1c;
        }

        .event-medium {
            background: #fff4df;
            color: #7a4f00;
        }

        .event-low {
            background: #e8f3ff;
            color: #1b4f8a;
        }

        body.dark-mode .event-high {
            background: #5a2d2d;
            color: #ffc0c0;
        }

        body.dark-mode .event-medium {
            background: #4d3b1f;
            color: #ffd88a;
        }

        body.dark-mode .event-low {
            background: #23344d;
            color: #a8d2ff;
        }

        .market-data-note {
            margin-top: -30px;
            margin-bottom: 30px;
            font-size: 12px;
            opacity: 0.75;
        }

        .calendar-note {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        body.dark-mode .info-box {
            background: #1a3a52;
            border-left-color: #667eea;
            color: #b0c4de;
        }
        
        .setup-guide {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 40px;
        }
        
        body.dark-mode .setup-guide {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .setup-guide h3 {
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .setup-guide ol {
            margin-left: 20px;
            line-height: 2;
        }
        
        .setup-guide li {
            margin-bottom: 10px;
        }
        
        .setup-guide code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        body.dark-mode .setup-guide code {
            background: #2a2a3a;
        }
        
        footer {
            background: white;
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid #eee;
            margin-top: 60px;
        }
        
        body.dark-mode footer {
            background: #1a1a2e;
            border-top-color: #333;
        }
        
        .theme-toggle {
            position: relative;
            background: white;
            border: none;
            padding: 10px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        body.dark-mode .theme-toggle {
            background: #1a2a4a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
    </style>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vmylxac7pb");
</script>
</head>
<body>
    <nav>
        <div class="container">
            <div class="logo">üí∞ Smart Investment Tips</div>
            <div>
                <a href="./index.html">Home</a> ¬∑
                <a href="./market.html">Markets</a> ¬∑
                <a href="./journal.html">Journal</a> ¬∑
                <a href="./news.html">News</a> ¬∑
                <a href="./advertise.html">Advertise</a> ¬∑
                <a href="./contact.html">Contact</a> ¬∑
                <a href="./auth.html">Login</a>
            </div>
        </div>
    </nav>
    
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>üìä Market Dashboard</h1>
                <p>Real-time market data for major indices and stocks</p>
                <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            </div>
            
            <div class="info-box">
                <strong>üìå Note:</strong> This dashboard uses delayed quotes first, and falls back to demo values if quote fetch fails.
                For trading decisions, always verify current prices on your broker's platform.
            </div>
            
            <div class="markets-grid" id="marketsGrid">
                <div class="market-card">
                    <div class="market-symbol">.GSPC / ^GSPC</div>
                    <div class="market-name">S&P 500 Index</div>
                    <div class="market-price" id="sp500-price">-</div>
                    <div class="market-change change-positive" id="sp500-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="sp500-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=SP500">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: SP:SPX</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">NASDAQ</div>
                    <div class="market-name">US Tech Stock Exchange</div>
                    <div class="market-price" id="nasdaq-price">-</div>
                    <div class="market-change change-positive" id="nasdaq-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="nasdaq-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=NASDAQ">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: NASDAQ:IXIC</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">DJI / ^DJI</div>
                    <div class="market-name">Dow Jones 30</div>
                    <div class="market-price" id="dow-price">-</div>
                    <div class="market-change change-positive" id="dow-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="dow-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=DOW">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: DJ:DJI</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">KOSPI</div>
                    <div class="market-name">Korea Stock Exchange</div>
                    <div class="market-price" id="kospi-price">-</div>
                    <div class="market-change change-positive" id="kospi-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="kospi-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=KOSPI">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: TVC:KOSPI</div>
                </div>
                
                <div class="market-card">
                    <div class="market-symbol">KOSDAQ</div>
                    <div class="market-name">Korea Tech Exchange</div>
                    <div class="market-price" id="kosdaq-price">-</div>
                    <div class="market-change change-positive" id="kosdaq-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="kosdaq-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=KOSDAQ">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: KRX:KQ11</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">AAPL</div>
                    <div class="market-name">Apple Inc.</div>
                    <div class="market-price" id="aapl-price">-</div>
                    <div class="market-change change-positive" id="aapl-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="aapl-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=AAPL">Symbol Board ‚Üí</a>
                    <div class="market-source">Source: Delayed feed (preferred) ¬∑ Ref symbol: NASDAQ:AAPL</div>
                </div>
            </div>
            <div class="market-data-note" id="marketDataNote">Displayed data: loading...</div>
            
            <div class="calendar-section">
                <h3>üóìÔ∏è Monthly Calendar for Key U.S. Economic Indicators</h3>
                <div class="calendar-header">
                    <div class="calendar-month" id="calendarMonthLabel">-</div>
                    <div style="font-size:12px; opacity:0.7;">Impact: High ¬∑ Medium ¬∑ Low</div>
                </div>
                <div class="calendar-grid" id="economicCalendarGrid"></div>
                <div class="calendar-note">Schedules may change. Please confirm with each institution's official calendar.</div>
            </div>

            <div class="setup-guide">
                <h3>üîß Schedule Guide</h3>
                <p style="margin-bottom: 20px;">This calendar shows expected release dates for key U.S. indicators in a monthly view.</p>
                <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">
                    Priority is given to high-impact items such as jobs data, CPI/PPI, retail sales, FOMC, GDP, and PCE.
                </p>
            </div>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <p style="opacity: 0.7; font-size: 14px;">&copy; 2026 Smart Investment Tips. Market data with 5-15 minute delay.</p>
            <p style="opacity:0.7; font-size:12px; margin-top:6px;">
                Data source note: Symbol cards (demo feed + reference symbols), economic calendar (summary of expected U.S. releases).
            </p>
            <p style="margin-top: 10px;">
                <button id="themeToggle" class="theme-toggle">üåô Dark Mode</button>
            </p>
        </div>
    </footer>
    
    <script>
        const DELAYED_QUOTE_SYMBOLS = {
            KOSPI: '^KS11',
            KOSDAQ: '^KQ11',
            NASDAQ: '^IXIC',
            SP500: '^GSPC',
            DOW: '^DJI',
            AAPL: 'AAPL'
        };

        const MARKET_ID_TO_SYMBOL = {
            kospi: 'KOSPI',
            kosdaq: 'KOSDAQ',
            nasdaq: 'NASDAQ',
            sp500: 'SP500',
            dow: 'DOW',
            aapl: 'AAPL'
        };

        const US_ECONOMIC_EVENTS = {
            '2026-02-27': [
                { title: 'Core PCE Price Index (MoM)', impact: 'high' },
                { title: 'Personal Income / Spending', impact: 'medium' }
            ],
            '2026-03-06': [
                { title: 'Non-Farm Payrolls', impact: 'high' },
                { title: 'Unemployment Rate', impact: 'high' }
            ],
            '2026-03-11': [
                { title: 'CPI (YoY / MoM)', impact: 'high' }
            ],
            '2026-03-12': [
                { title: 'PPI (YoY / MoM)', impact: 'medium' },
                { title: 'Initial Jobless Claims', impact: 'medium' }
            ],
            '2026-03-17': [
                { title: 'Retail Sales', impact: 'high' },
                { title: 'Industrial Production', impact: 'medium' }
            ],
            '2026-03-18': [
                { title: 'FOMC Rate Decision', impact: 'high' },
                { title: 'Fed Economic Projections', impact: 'high' }
            ],
            '2026-03-19': [
                { title: 'Initial Jobless Claims', impact: 'medium' },
                { title: 'Existing Home Sales', impact: 'low' }
            ],
            '2026-03-26': [
                { title: 'GDP (Final, QoQ)', impact: 'high' },
                { title: 'Durable Goods Orders', impact: 'medium' }
            ],
            '2026-03-27': [
                { title: 'Core PCE Price Index', impact: 'high' },
                { title: 'University of Michigan Sentiment', impact: 'low' }
            ],
            '2026-03-31': [
                { title: 'CB Consumer Confidence', impact: 'medium' }
            ]
        };

        let delayedQuotes = {};
        const MARKET_CACHE_KEY = 'market_quote_cache_v1';

        function loadMarketCache() {
            try {
                const raw = localStorage.getItem(MARKET_CACHE_KEY);
                const parsed = JSON.parse(raw || '{}');
                const restored = {};
                Object.entries(parsed || {}).forEach(([symbol, q]) => {
                    if (!q || typeof q.price !== 'number') return;
                    restored[symbol] = {
                        price: Number(q.price),
                        prevClose: typeof q.prevClose === 'number' ? Number(q.prevClose) : Number(q.price),
                        time: q.time ? new Date(q.time) : new Date()
                    };
                });
                return restored;
            } catch {
                return {};
            }
        }

        function saveMarketCache(quotesBySymbol) {
            try {
                const serializable = {};
                Object.entries(quotesBySymbol || {}).forEach(([symbol, q]) => {
                    if (!q || typeof q.price !== 'number') return;
                    serializable[symbol] = {
                        price: Number(q.price),
                        prevClose: typeof q.prevClose === 'number' ? Number(q.prevClose) : Number(q.price),
                        time: q.time instanceof Date ? q.time.toISOString() : new Date().toISOString()
                    };
                });
                localStorage.setItem(MARKET_CACHE_KEY, JSON.stringify(serializable));
            } catch {
            }
        }

        function buildFallbackQuote(symbol, base) {
            const now = new Date();
            const phase = Math.floor(Date.now() / 600000);
            const seed = symbol.length * 31 + symbol.charCodeAt(0);
            const wave = Math.sin((phase + seed) * 0.31) * 0.0028 + Math.cos((phase + seed) * 0.17) * 0.0019;
            const price = Number((base * (1 + wave)).toFixed(2));
            return {
                price,
                prevClose: Number(base.toFixed(2)),
                time: now
            };
        }

        async function fetchDelayedQuotes() {
            const pairs = Object.entries(DELAYED_QUOTE_SYMBOLS);
            const yahooList = pairs.map(([, yahoo]) => yahoo).join(',');
            const response = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(yahooList)}`);
            if (!response.ok) throw new Error('Delayed quote HTTP error');
            const data = await response.json();
            const results = data?.quoteResponse?.result;
            if (!Array.isArray(results)) throw new Error('Delayed quote payload error');

            const reverseMap = {};
            pairs.forEach(([appSymbol, yahooSymbol]) => {
                reverseMap[yahooSymbol] = appSymbol;
            });

            const next = {};
            results.forEach(item => {
                const appSymbol = reverseMap[item.symbol];
                if (!appSymbol) return;
                if (typeof item.regularMarketPrice !== 'number') return;
                next[appSymbol] = {
                    price: Number(item.regularMarketPrice),
                    prevClose: typeof item.regularMarketPreviousClose === 'number' ? Number(item.regularMarketPreviousClose) : null,
                    time: typeof item.regularMarketTime === 'number' ? new Date(item.regularMarketTime * 1000) : new Date()
                };
            });

            delayedQuotes = next;
        }

        function getTargetMonth(today = new Date()) {
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const remainDays = endOfMonth - today.getDate();
            if (remainDays < 7) {
                return new Date(today.getFullYear(), today.getMonth() + 1, 1);
            }
            return firstDayOfMonth;
        }

        function renderEconomicCalendar() {
            const grid = document.getElementById('economicCalendarGrid');
            const monthLabel = document.getElementById('calendarMonthLabel');
            if (!grid || !monthLabel) return;

            const target = getTargetMonth();
            const year = target.getFullYear();
            const month = target.getMonth();
            const monthName = target.toLocaleString('en-US', { month: 'long' });
            monthLabel.textContent = `${monthName} ${year} (Expected U.S. Economic Releases)`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const weekHeads = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = '';
            weekHeads.forEach(day => {
                html += `<div class="calendar-day-head">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-cell empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = US_ECONOMIC_EVENTS[key] || [];
                const eventsHtml = events.map(evt => {
                    const impactClass = evt.impact === 'high' ? 'event-high' : (evt.impact === 'medium' ? 'event-medium' : 'event-low');
                    const impactText = evt.impact === 'high' ? 'High' : (evt.impact === 'medium' ? 'Medium' : 'Low');
                    return `<div class="event-item ${impactClass}">${evt.title} ¬∑ ${impactText}</div>`;
                }).join('');

                html += `<div class="calendar-cell"><div class="calendar-day-num">${day}</div>${eventsHtml}</div>`;
            }

            const rows = Math.ceil((firstDay + daysInMonth) / 7);
            const totalCells = rows * 7;
            const trailing = totalCells - (firstDay + daysInMonth);
            for (let i = 0; i < trailing; i++) {
                html += '<div class="calendar-cell empty"></div>';
            }

            grid.innerHTML = html;
        }

        function formatChangePercent(deltaPercent) {
            const sign = deltaPercent >= 0 ? '+' : '';
            return `${sign}${deltaPercent.toFixed(2)}%`;
        }

        async function updateMarketData() {
            const markets = [
                { id: 'sp500', base: 5150.44 },
                { id: 'nasdaq', base: 16520.22 },
                { id: 'dow', base: 38800.10 },
                { id: 'kospi', base: 2580.12 },
                { id: 'kosdaq', base: 865.34 },
                { id: 'aapl', base: 187.22 }
            ];

            let usedDelayed = false;
            try {
                await fetchDelayedQuotes();
                usedDelayed = Object.keys(delayedQuotes).length > 0;
            } catch {
                usedDelayed = false;
            }

            const cachedQuotes = loadMarketCache();
            const nextCache = { ...cachedQuotes };
            let delayedCount = 0;

            markets.forEach(market => {
                const symbol = MARKET_ID_TO_SYMBOL[market.id] || market.id.toUpperCase();
                const delayed = delayedQuotes[symbol] || null;
                const quote = delayed || cachedQuotes[symbol] || buildFallbackQuote(symbol, market.base);

                if (delayed) delayedCount += 1;
                if (quote) nextCache[symbol] = quote;

                const price = quote?.price ?? market.base;
                const prevPrice = quote?.prevClose && quote.prevClose !== 0 ? quote.prevClose : market.base;
                const deltaPercent = price != null && prevPrice != null && prevPrice !== 0
                    ? ((price - prevPrice) / prevPrice) * 100
                    : null;
                const isPositive = deltaPercent >= 0;

                document.getElementById(`${market.id}-price`).textContent = `$${price.toFixed(2)}`;
                document.getElementById(`${market.id}-change`).textContent = deltaPercent == null ? '+0.00%' : formatChangePercent(deltaPercent);
                document.getElementById(`${market.id}-change`).className = `market-change ${deltaPercent == null ? '' : (isPositive ? 'change-positive' : 'change-negative')}`;
                document.getElementById(`${market.id}-time`).textContent = (quote?.time instanceof Date ? quote.time : new Date()).toLocaleTimeString();
            });

            saveMarketCache(nextCache);

            const note = document.getElementById('marketDataNote');
            if (note) {
                note.textContent = usedDelayed
                    ? `Displayed data: Yahoo Finance delayed quotes (free, usually ~15 min delay) ¬∑ Missing items fallback to cache/base index (${delayedCount}/${markets.length} received)`
                    : 'Displayed data: delayed quotes unavailable ¬∑ showing cache/base index values';
            }
        }

        async function refreshData() {
            await updateMarketData();
            alert('‚úÖ Data refresh complete');
        }

        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è Light Mode';
        }

        themeToggle.addEventListener('click', function() {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        });

        window.addEventListener('load', async function() {
            renderEconomicCalendar();
            await updateMarketData();
            setInterval(updateMarketData, 60000);
        });
    </script>
    <script src="./analytics.js"></script>
    <script src="./legal-consent.js"></script>
    <script src="./assistant-widget.js"></script>
</body>
</html>
