<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time market data and price tracking for stocks, indices and more.">
    <meta name="robots" content="index,follow,max-image-preview:large">
    <link rel="canonical" href="https://si-tip.com/market.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Market Dashboard - Smart Investment Tips">
    <meta property="og:description" content="Track stocks and indices with a live market dashboard and quick quote lookup.">
    <meta property="og:url" content="https://si-tip.com/market.html">
    <meta property="og:site_name" content="Smart Investment Tips">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Market Dashboard - Smart Investment Tips">
    <meta name="twitter:description" content="Track stocks and indices with a live market dashboard and quick quote lookup.">
    <title>Market Dashboard - Smart Investment Tips</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', sans-serif;
            background: #f8f9fa;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background: #0f0f1e;
            color: #e0e0e0;
        }
        
        nav {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        body.dark-mode nav {
            background: #1a1a2e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        nav .logo {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        body.dark-mode nav a {
            color: #e0e0e0;
        }
        
        nav a:hover {
            color: #667eea;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .dashboard-section {
            padding: 60px 20px;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .dashboard-header h1 {
            font-size: 42px;
            margin-bottom: 10px;
        }
        
        .dashboard-header p {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .markets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .market-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        body.dark-mode .market-card {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .market-card:hover {
            transform: translateY(-5px);
        }
        
        .market-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .market-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .market-price {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .market-change {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .change-positive {
            background: #d4edda;
            color: #155724;
        }
        
        .change-negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        body.dark-mode .change-positive {
            background: #2d5a3d;
            color: #90ee90;
        }
        
        body.dark-mode .change-negative {
            background: #5a2d2d;
            color: #ff6b6b;
        }
        
        .market-time {
            font-size: 12px;
            opacity: 0.6;
        }

        .market-source {
            margin-top: 8px;
            font-size: 11px;
            opacity: 0.7;
        }

        .board-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 12px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .board-link:hover {
            text-decoration: underline;
        }
        
        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        body.dark-mode .calendar-section {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .calendar-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .calendar-month {
            font-size: 14px;
            opacity: 0.8;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            border: 1px solid #e8ecf1;
            border-radius: 10px;
            overflow: hidden;
        }

        body.dark-mode .calendar-grid {
            border-color: #2f3348;
        }

        .calendar-day-head {
            padding: 10px 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            background: #f5f8fc;
            border-right: 1px solid #e8ecf1;
        }

        .calendar-day-head:last-child {
            border-right: none;
        }

        body.dark-mode .calendar-day-head {
            background: #20243a;
            border-right-color: #2f3348;
        }

        .calendar-cell {
            min-height: 120px;
            padding: 8px;
            border-top: 1px solid #e8ecf1;
            border-right: 1px solid #e8ecf1;
            background: #fff;
        }

        .calendar-cell:nth-child(7n) {
            border-right: none;
        }

        body.dark-mode .calendar-cell {
            background: #171a2d;
            border-top-color: #2f3348;
            border-right-color: #2f3348;
        }

        .calendar-cell.empty {
            background: #fafbfd;
        }

        body.dark-mode .calendar-cell.empty {
            background: #141729;
        }

        .calendar-day-num {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
            opacity: 0.85;
        }

        .event-item {
            font-size: 11px;
            line-height: 1.35;
            border-radius: 6px;
            padding: 4px 6px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .event-high {
            background: #ffe5e5;
            color: #8b1c1c;
        }

        .event-medium {
            background: #fff4df;
            color: #7a4f00;
        }

        .event-low {
            background: #e8f3ff;
            color: #1b4f8a;
        }

        body.dark-mode .event-high {
            background: #5a2d2d;
            color: #ffc0c0;
        }

        body.dark-mode .event-medium {
            background: #4d3b1f;
            color: #ffd88a;
        }

        body.dark-mode .event-low {
            background: #23344d;
            color: #a8d2ff;
        }

        .market-data-note {
            margin-top: -30px;
            margin-bottom: 30px;
            font-size: 12px;
            opacity: 0.75;
        }

        .calendar-note {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.7;
        }

        .dividend-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        body.dark-mode .dividend-section {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dividend-tabs {
            display: flex;
            gap: 10px;
            margin: 14px 0;
            flex-wrap: wrap;
        }

        .dividend-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .dividend-sort-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dividend-sort-btn {
            border: 1px solid #d7dce5;
            background: #f8fafc;
            color: #334155;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .dividend-sort-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }

        body.dark-mode .dividend-sort-btn {
            background: #20243a;
            color: #e2e8f0;
            border-color: #353b57;
        }

        body.dark-mode .dividend-sort-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }

        .dividend-tab-btn {
            border: 1px solid #d7dce5;
            background: #f8fafc;
            color: #334155;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
        }

        .dividend-tab-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }

        body.dark-mode .dividend-tab-btn {
            background: #20243a;
            color: #e2e8f0;
            border-color: #353b57;
        }

        body.dark-mode .dividend-tab-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }

        .dividend-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
        }

        .dividend-item {
            border: 1px solid #e8ecf1;
            border-radius: 10px;
            padding: 10px 12px;
            background: #fff;
        }

        body.dark-mode .dividend-item {
            background: #171a2d;
            border-color: #2f3348;
        }

        .dividend-rank {
            font-size: 12px;
            color: #667085;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .dividend-symbol {
            font-size: 14px;
            font-weight: 800;
            color: #667eea;
        }

        .dividend-name {
            font-size: 13px;
            margin: 4px 0 6px;
            font-weight: 600;
        }

        .dividend-meta {
            font-size: 12px;
            opacity: 0.75;
        }

        .dividend-live {
            margin-top: 6px;
            font-size: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dividend-badge {
            padding: 3px 7px;
            border-radius: 999px;
            background: #eef2ff;
            color: #334155;
            font-weight: 700;
        }

        body.dark-mode .dividend-badge {
            background: #262c4a;
            color: #e2e8f0;
        }

        .dividend-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .dividend-actions input {
            width: 90px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #d7dce5;
            font-size: 12px;
        }

        .dividend-add-btn {
            border: none;
            background: #2563eb;
            color: #fff;
            border-radius: 8px;
            padding: 7px 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .dividend-refresh-note {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.75;
        }

        .dividend-portfolio {
            margin-top: 18px;
            border: 1px solid #e8ecf1;
            border-radius: 10px;
            padding: 14px;
            background: #fff;
            overflow-x: auto;
        }
        .dividend-portfolio-wrap { overflow-x: auto; }

        body.dark-mode .dividend-portfolio {
            background: #171a2d;
            border-color: #2f3348;
        }

        .dividend-portfolio h4 {
            font-size: 15px;
            margin-bottom: 10px;
        }

        .dividend-portfolio-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .dividend-portfolio-table th,
        .dividend-portfolio-table td {
            border-bottom: 1px solid #e8ecf1;
            padding: 8px 6px;
            text-align: left;
        }

        body.dark-mode .dividend-portfolio-table th,
        body.dark-mode .dividend-portfolio-table td {
            border-bottom-color: #2f3348;
        }

        .dividend-portfolio-table input {
            width: 80px;
            padding: 5px 7px;
            border-radius: 7px;
            border: 1px solid #d7dce5;
            font-size: 12px;
        }

        .dividend-remove-btn {
            border: 1px solid #cbd5e1;
            background: #fff;
            border-radius: 7px;
            padding: 5px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        body.dark-mode .dividend-remove-btn {
            background: #20243a;
            border-color: #475569;
            color: #e2e8f0;
        }

        .dividend-portfolio-summary {
            margin-top: 12px;
            padding: 12px 14px;
            font-size: 13px;
            font-weight: 600;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e8ecf1;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        body.dark-mode .dividend-portfolio-summary {
            background: #20243a;
            border-color: #2f3348;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        body.dark-mode .info-box {
            background: #1a3a52;
            border-left-color: #667eea;
            color: #b0c4de;
        }
        
        .setup-guide {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 40px;
        }
        
        body.dark-mode .setup-guide {
            background: #1a1a2e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .setup-guide h3 {
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .setup-guide ol {
            margin-left: 20px;
            line-height: 2;
        }
        
        .setup-guide li {
            margin-bottom: 10px;
        }
        
        .setup-guide code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        body.dark-mode .setup-guide code {
            background: #2a2a3a;
        }
        
        footer {
            background: white;
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid #eee;
            margin-top: 60px;
        }
        
        body.dark-mode footer {
            background: #1a1a2e;
            border-top-color: #333;
        }
        
        .theme-toggle {
            position: relative;
            background: white;
            border: none;
            padding: 10px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        body.dark-mode .theme-toggle {
            background: #1a2a4a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
    
        .logo-mark {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(15,23,42,0.18);
            background: #fff;
            padding: 2px;
            flex-shrink: 0;
        }
        nav .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vmylxac7pb");
</script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=3">
    <link rel="shortcut icon" href="/favicon.ico?v=3">
</head>
<body>
    <nav>
        <div class="container">
            <div class="logo"><img class="logo-mark" src="./favicon.svg" alt="SI">Smart Investment Tips</div>
            <div>
                <a href="./index.html">Home</a> ·
                <a href="./market.html">Markets</a> ·
                <a href="./journal.html">Journal</a> ·
                <a href="./prop.html">Prop</a> ·
                <a href="./advertise.html">Advertise</a> ·
                <a href="./contact.html">Contact</a> ·
                <a href="./auth.html">Login</a>
            </div>
        </div>
    </nav>
    
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>Market Dashboard</h1>
                <p>Real-time market data for major indices and stocks</p>
                <button class="refresh-btn" onclick="refreshData()">&#8635; Refresh Data</button>
            </div>
            
            <div class="info-box">
                <strong>&#128204; Note:</strong> This dashboard uses delayed quotes first, and falls back to demo values if quote fetch fails.
                For trading decisions, always verify current prices on your broker's platform.
            </div>
            
            <div class="markets-grid" id="marketsGrid">
                <div class="market-card">
                    <div class="market-symbol">.GSPC / ^GSPC</div>
                    <div class="market-name">S&P 500 Index</div>
                    <div class="market-price" id="sp500-price">-</div>
                    <div class="market-change change-positive" id="sp500-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="sp500-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=SP500">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: SP:SPX</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">NASDAQ</div>
                    <div class="market-name">US Tech Stock Exchange</div>
                    <div class="market-price" id="nasdaq-price">-</div>
                    <div class="market-change change-positive" id="nasdaq-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="nasdaq-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=NASDAQ">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: NASDAQ:IXIC</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">DJI / ^DJI</div>
                    <div class="market-name">Dow Jones 30</div>
                    <div class="market-price" id="dow-price">-</div>
                    <div class="market-change change-positive" id="dow-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="dow-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=DOW">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: DJ:DJI</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">KOSPI</div>
                    <div class="market-name">Korea Stock Exchange</div>
                    <div class="market-price" id="kospi-price">-</div>
                    <div class="market-change change-positive" id="kospi-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="kospi-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=KOSPI">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: TVC:KOSPI</div>
                </div>
                
                <div class="market-card">
                    <div class="market-symbol">KOSDAQ</div>
                    <div class="market-name">Korea Tech Exchange</div>
                    <div class="market-price" id="kosdaq-price">-</div>
                    <div class="market-change change-positive" id="kosdaq-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="kosdaq-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=KOSDAQ">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: KRX:KQ11</div>
                </div>

                <div class="market-card">
                    <div class="market-symbol">AAPL</div>
                    <div class="market-name">Apple Inc.</div>
                    <div class="market-price" id="aapl-price">-</div>
                    <div class="market-change change-positive" id="aapl-change">+0.00%</div>
                    <div class="market-time">Last updated: <span id="aapl-time">-</span></div>
                    <a class="board-link" href="./symbol.html?symbol=AAPL">Symbol Board</a>
                    <div class="market-source">Source: Delayed feed (preferred) · Ref symbol: NASDAQ:AAPL</div>
                </div>
            </div>
            <div class="market-data-note" id="marketDataNote">Displayed data: loading...</div>

            <div class="dividend-section">
                <div class="dividend-title-row">
                    <h3 style="margin:0;">Dividend Stocks Category</h3>
                    <div class="dividend-sort-buttons">
                        <button class="dividend-sort-btn active" id="sortMarketCapBtn" type="button" data-sort="market_cap_desc">Highest Market Cap</button>
                        <button class="dividend-sort-btn" id="sortDividendAmountBtn" type="button" data-sort="dividend_amount_desc">Highest Dividend Amount</button>
                        <button class="dividend-sort-btn" id="sortTurnoverBtn" type="button" data-sort="turnover_desc">Highest Turnover</button>
                    </div>
                </div>
                <p id="dividendCriteriaText" style="font-size:13px; opacity:0.75; margin-top:8px;">Stocks are sorted by Highest Market Cap.</p>
                <div class="dividend-tabs">
                    <button class="dividend-tab-btn active" id="dividendWorldBtn" type="button">World Top 50</button>
                    <button class="dividend-tab-btn" id="dividendUsBtn" type="button">US Top 50</button>
                </div>
                <ol class="dividend-list" id="dividendList"></ol>
                <div class="dividend-refresh-note" id="dividendRefreshNote">Dividend list data: loading...</div>

                <div class="dividend-portfolio">
                    <h4>Custom Dividend Portfolio Builder</h4>
                    <p style="font-size:12px; opacity:0.75; margin-bottom:10px;">&#47785;&#47197;&#50640;&#49436; &#51333;&#47785;&#51012; &#49440;&#53469;&#54644; &#49688;&#47049;&#51012; &#51077;&#47141; &#54980; &#54252;&#53944;&#54260;&#47532;&#50724;&#50640; &#52628;&#44032;&#54616;&#49464;&#50836;. &#51452;&#44032;·&#50672;&#44036; &#50696;&#49345; &#48176;&#45817;&#44552;·&#50900; &#50696;&#49345; &#48176;&#45817;&#44552;·&#48176;&#45817; &#49688;&#51061;&#47456;&#51012; &#49892;&#49884;&#44036;&#51004;&#47196; &#44228;&#49328;&#54633;&#45768;&#45796;.</p>
                    <table class="dividend-portfolio-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Value</th>
                                <th>Annual Dividend</th>
                                <th>Monthly Dividend</th>
                                <th>Yield</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="dividendPortfolioBody">
                            <tr><td colspan="9" class="calendar-note">No stocks added yet.</td></tr>
                        </tbody>
                    </table>
                    <div class="dividend-portfolio-summary" id="dividendPortfolioSummary">Total value: $0.00</div>
                </div>
                <div class="calendar-note" style="margin-top:12px;">Note: Always verify dividends, payout dates, and tax rules on official filings before investing.</div>
            </div>
            
            <div class="calendar-section">
                <h3>Monthly Calendar for Key U.S. Economic Indicators</h3>
                <div class="calendar-header">
                    <div class="calendar-month" id="calendarMonthLabel">-</div>
                    <div style="font-size:12px; opacity:0.7;">Impact: High · Medium · Low</div>
                </div>
                <div class="calendar-grid" id="economicCalendarGrid"></div>
                <div class="calendar-note">Schedules may change. Please confirm with each institution's official calendar.</div>
            </div>

            <div class="setup-guide">
                <h3>&#128197; Schedule Guide</h3>
                <p style="margin-bottom: 20px;">This calendar shows expected release dates for key U.S. indicators in a monthly view.</p>
                <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">
                    Priority is given to high-impact items such as jobs data, CPI/PPI, retail sales, FOMC, GDP, and PCE.
                </p>
            </div>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <p style="opacity: 0.7; font-size: 14px;">&copy; 2026 Smart Investment Tips. Market data with 5-15 minute delay.</p>
            <p style="opacity:0.7; font-size:12px; margin-top:6px;">
                Data source note: Symbol cards (demo feed + reference symbols), economic calendar (summary of expected U.S. releases).
            </p>
            <p style="margin-top: 10px;">
                <button id="themeToggle" class="theme-toggle">&#127769; Dark Mode</button>
            </p>
        </div>
    </footer>
    
    <script>
        const DELAYED_QUOTE_SYMBOLS = {
            KOSPI: '^KS11',
            KOSDAQ: '^KQ11',
            NASDAQ: '^IXIC',
            SP500: '^GSPC',
            DOW: '^DJI',
            AAPL: 'AAPL'
        };

        const MARKET_ID_TO_SYMBOL = {
            kospi: 'KOSPI',
            kosdaq: 'KOSDAQ',
            nasdaq: 'NASDAQ',
            sp500: 'SP500',
            dow: 'DOW',
            aapl: 'AAPL'
        };

        const DIVIDEND_TOP50_WORLD = [
            { symbol: 'NESN.SW', name: 'Nestlé', region: 'Switzerland' },
            { symbol: 'NOVO-B.CO', name: 'Novo Nordisk', region: 'Denmark' },
            { symbol: 'ASML.AS', name: 'ASML Holding', region: 'Netherlands' },
            { symbol: 'ROG.SW', name: 'Roche Holding', region: 'Switzerland' },
            { symbol: 'SHEL', name: 'Shell', region: 'UK' },
            { symbol: 'TTE', name: 'TotalEnergies', region: 'France' },
            { symbol: 'UL', name: 'Unilever', region: 'UK' },
            { symbol: 'BP', name: 'BP', region: 'UK' },
            { symbol: 'BHP', name: 'BHP Group', region: 'Australia' },
            { symbol: 'RIO', name: 'Rio Tinto', region: 'UK/Australia' },
            { symbol: 'ENB', name: 'Enbridge', region: 'Canada' },
            { symbol: 'TD', name: 'Toronto-Dominion Bank', region: 'Canada' },
            { symbol: 'RY', name: 'Royal Bank of Canada', region: 'Canada' },
            { symbol: 'BNS', name: 'Bank of Nova Scotia', region: 'Canada' },
            { symbol: 'CM', name: 'CIBC', region: 'Canada' },
            { symbol: 'SU', name: 'Suncor Energy', region: 'Canada' },
            { symbol: 'BBVA', name: 'Banco Bilbao Vizcaya Argentaria', region: 'Spain' },
            { symbol: 'SAN', name: 'Banco Santander', region: 'Spain' },
            { symbol: 'IBE.MC', name: 'Iberdrola', region: 'Spain' },
            { symbol: 'ENEL.MI', name: 'Enel', region: 'Italy' },
            { symbol: 'ISP.MI', name: 'Intesa Sanpaolo', region: 'Italy' },
            { symbol: 'UCG.MI', name: 'UniCredit', region: 'Italy' },
            { symbol: 'AIR.PA', name: 'Air Liquide', region: 'France' },
            { symbol: 'MC.PA', name: 'LVMH', region: 'France' },
            { symbol: 'BN.PA', name: 'Danone', region: 'France' },
            { symbol: 'DG.PA', name: 'Vinci', region: 'France' },
            { symbol: 'ORA.PA', name: 'Orange', region: 'France' },
            { symbol: 'RWE.DE', name: 'RWE', region: 'Germany' },
            { symbol: 'ALV.DE', name: 'Allianz', region: 'Germany' },
            { symbol: 'DTE.DE', name: 'Deutsche Telekom', region: 'Germany' },
            { symbol: 'BAS.DE', name: 'BASF', region: 'Germany' },
            { symbol: 'SIE.DE', name: 'Siemens', region: 'Germany' },
            { symbol: 'BMW.DE', name: 'BMW', region: 'Germany' },
            { symbol: 'VOW3.DE', name: 'Volkswagen Pref', region: 'Germany' },
            { symbol: '7203.T', name: 'Toyota Motor', region: 'Japan' },
            { symbol: '9432.T', name: 'NTT', region: 'Japan' },
            { symbol: '8306.T', name: 'Mitsubishi UFJ Financial', region: 'Japan' },
            { symbol: '8058.T', name: 'Mitsubishi Corp', region: 'Japan' },
            { symbol: '9983.T', name: 'Fast Retailing', region: 'Japan' },
            { symbol: '005930.KS', name: 'Samsung Electronics', region: 'Korea' },
            { symbol: '000660.KS', name: 'SK hynix', region: 'Korea' },
            { symbol: '035420.KS', name: 'NAVER', region: 'Korea' },
            { symbol: '051910.KS', name: 'LG Chem', region: 'Korea' },
            { symbol: '078930.KS', name: 'GS Holdings', region: 'Korea' },
            { symbol: '3690.HK', name: 'Meituan', region: 'Hong Kong/China' },
            { symbol: '0700.HK', name: 'Tencent', region: 'Hong Kong/China' },
            { symbol: '1299.HK', name: 'AIA Group', region: 'Hong Kong' },
            { symbol: '3988.HK', name: 'Bank of China', region: 'Hong Kong/China' },
            { symbol: '0883.HK', name: 'CNOOC', region: 'Hong Kong/China' },
            { symbol: 'VALE', name: 'Vale', region: 'Brazil' }
        ];

        const DIVIDEND_TOP50_US = [
            { symbol: 'MSFT', name: 'Microsoft' },
            { symbol: 'AAPL', name: 'Apple' },
            { symbol: 'NVDA', name: 'NVIDIA' },
            { symbol: 'AVGO', name: 'Broadcom' },
            { symbol: 'XOM', name: 'Exxon Mobil' },
            { symbol: 'JPM', name: 'JPMorgan Chase' },
            { symbol: 'WMT', name: 'Walmart' },
            { symbol: 'JNJ', name: 'Johnson & Johnson' },
            { symbol: 'PG', name: 'Procter & Gamble' },
            { symbol: 'KO', name: 'Coca-Cola' },
            { symbol: 'PEP', name: 'PepsiCo' },
            { symbol: 'ABBV', name: 'AbbVie' },
            { symbol: 'CVX', name: 'Chevron' },
            { symbol: 'BAC', name: 'Bank of America' },
            { symbol: 'WFC', name: 'Wells Fargo' },
            { symbol: 'PM', name: 'Philip Morris International' },
            { symbol: 'MO', name: 'Altria Group' },
            { symbol: 'T', name: 'AT&T' },
            { symbol: 'VZ', name: 'Verizon' },
            { symbol: 'IBM', name: 'IBM' },
            { symbol: 'CSCO', name: 'Cisco Systems' },
            { symbol: 'QCOM', name: 'Qualcomm' },
            { symbol: 'INTC', name: 'Intel' },
            { symbol: 'TXN', name: 'Texas Instruments' },
            { symbol: 'AMGN', name: 'Amgen' },
            { symbol: 'MRK', name: 'Merck & Co.' },
            { symbol: 'PFE', name: 'Pfizer' },
            { symbol: 'BMY', name: 'Bristol-Myers Squibb' },
            { symbol: 'MCD', name: 'McDonald\'s' },
            { symbol: 'HD', name: 'Home Depot' },
            { symbol: 'LOW', name: 'Lowe\'s' },
            { symbol: 'UPS', name: 'UPS' },
            { symbol: 'RTX', name: 'RTX' },
            { symbol: 'LMT', name: 'Lockheed Martin' },
            { symbol: 'CAT', name: 'Caterpillar' },
            { symbol: 'DE', name: 'Deere & Co.' },
            { symbol: 'MMM', name: '3M' },
            { symbol: 'GE', name: 'GE Aerospace' },
            { symbol: 'DUK', name: 'Duke Energy' },
            { symbol: 'SO', name: 'Southern Company' },
            { symbol: 'NEE', name: 'NextEra Energy' },
            { symbol: 'AEP', name: 'American Electric Power' },
            { symbol: 'O', name: 'Realty Income' },
            { symbol: 'SPG', name: 'Simon Property Group' },
            { symbol: 'PLD', name: 'Prologis' },
            { symbol: 'SCHW', name: 'Charles Schwab' },
            { symbol: 'BLK', name: 'BlackRock' },
            { symbol: 'C', name: 'Citigroup' },
            { symbol: 'USB', name: 'U.S. Bancorp' },
            { symbol: 'TROW', name: 'T. Rowe Price' }
        ];

        const DIVIDEND_PORTFOLIO_KEY = 'dividend_portfolio_v1';
        let currentDividendTab = 'world';
        let currentDividendSort = 'market_cap_desc';
        let dividendQuoteCache = {};
        let dividendPortfolio = {};

        function getActiveDividendItems() {
            return currentDividendTab === 'us' ? DIVIDEND_TOP50_US : DIVIDEND_TOP50_WORLD;
        }

        function getDividendCacheKey(item) {
            return `${currentDividendTab}:${item.symbol}`;
        }

        function formatMarketCap(value) {
            if (typeof value !== 'number' || !Number.isFinite(value) || value <= 0) return 'N/A';
            if (value >= 1_000_000_000_000) return `$${(value / 1_000_000_000_000).toFixed(2)}T`;
            if (value >= 1_000_000_000) return `$${(value / 1_000_000_000).toFixed(1)}B`;
            if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
            return `$${value.toFixed(0)}`;
        }

        function getSortValue(item, mode) {
            const quote = dividendQuoteCache[getDividendCacheKey(item)] || {};
            if (mode === 'market_cap_desc') {
                return typeof quote.marketCap === 'number' ? quote.marketCap : -1;
            }
            if (mode === 'turnover_desc') {
                return typeof quote.turnover === 'number' ? quote.turnover : -1;
            }
            return typeof quote.dividendRate === 'number' ? quote.dividendRate : -1;
        }

        function getSortedDividendItems(items) {
            const list = [...items];
            if (currentDividendSort === 'turnover_desc') {
                list.sort((a, b) => getSortValue(b, 'turnover_desc') - getSortValue(a, 'turnover_desc'));
                return list;
            }
            if (currentDividendSort === 'market_cap_desc') {
                list.sort((a, b) => getSortValue(b, 'market_cap_desc') - getSortValue(a, 'market_cap_desc'));
                return list;
            }
            list.sort((a, b) => getSortValue(b, 'dividend_amount_desc') - getSortValue(a, 'dividend_amount_desc'));
            return list;
        }

        function loadDividendPortfolio() {
            try {
                const raw = localStorage.getItem(DIVIDEND_PORTFOLIO_KEY);
                const parsed = JSON.parse(raw || '{}');
                dividendPortfolio = parsed && typeof parsed === 'object' ? parsed : {};
            } catch {
                dividendPortfolio = {};
            }
        }

        function saveDividendPortfolio() {
            try {
                localStorage.setItem(DIVIDEND_PORTFOLIO_KEY, JSON.stringify(dividendPortfolio));
            } catch {
            }
        }

        function buildDividendFallback(symbol) {
            const seed = symbol.split('').reduce((acc, ch) => acc + ch.charCodeAt(0), 0);
            const base = 40 + (seed % 260);
            const wave = Math.sin((Date.now() / 600000) + seed) * 0.03;
            const price = Number((base * (1 + wave)).toFixed(2));
            const changePercent = Number((wave * 100).toFixed(2));
            const dividendYield = Number((1.2 + (seed % 55) / 10).toFixed(2));
            const dividendRate = Number((price * (dividendYield / 100)).toFixed(2));
            const turnover = Number((price * (100000 + (seed % 900000))).toFixed(0));
            const marketCap = Number(((seed % 900) + 100) * 1_000_000_000);
            return { price, changePercent, dividendYield, dividendRate, turnover, marketCap, source: 'fallback' };
        }

        async function updateDividendQuotes() {
            const items = getActiveDividendItems();
            const symbols = items.map(item => item.symbol).join(',');
            let successCount = 0;
            let fallbackCount = 0;

            try {
                const response = await fetch(`/api/quote?symbols=${encodeURIComponent(symbols)}`);
                if (!response.ok) throw new Error('Dividend quote HTTP error');
                const payload = await response.json();
                const rows = Array.isArray(payload?.quoteResponse?.result) ? payload.quoteResponse.result : [];
                const mapBySymbol = {};
                rows.forEach(row => {
                    if (!row || !row.symbol) return;
                    mapBySymbol[row.symbol] = row;
                });

                items.forEach(item => {
                    const cacheKey = getDividendCacheKey(item);
                    const row = mapBySymbol[item.symbol];
                    if (row && typeof row.regularMarketPrice === 'number') {
                        successCount += 1;
                        dividendQuoteCache[cacheKey] = {
                            price: Number(row.regularMarketPrice),
                            changePercent: typeof row.regularMarketChangePercent === 'number' ? Number(row.regularMarketChangePercent) : null,
                            dividendYield: typeof row.trailingAnnualDividendYield === 'number' ? Number((row.trailingAnnualDividendYield * 100).toFixed(2)) : null,
                            dividendRate: typeof row.trailingAnnualDividendRate === 'number' ? Number(row.trailingAnnualDividendRate) : null,
                            turnover: (typeof row.regularMarketVolume === 'number' && typeof row.regularMarketPrice === 'number')
                                ? Number(row.regularMarketVolume) * Number(row.regularMarketPrice)
                                : null,
                            marketCap: typeof row.marketCap === 'number' ? Number(row.marketCap) : null,
                            source: 'yahoo'
                        };
                    } else {
                        fallbackCount += 1;
                        dividendQuoteCache[cacheKey] = buildDividendFallback(item.symbol);
                    }
                });
            } catch {
                items.forEach(item => {
                    const cacheKey = getDividendCacheKey(item);
                    fallbackCount += 1;
                    dividendQuoteCache[cacheKey] = buildDividendFallback(item.symbol);
                });
            }

            const note = document.getElementById('dividendRefreshNote');
            if (note) {
                note.textContent = `Dividend list data: ${successCount > 0 ? 'Yahoo delayed quotes + market cap/dividend amount/turnover' : 'fallback mode'} · received ${successCount}/${items.length}, fallback ${fallbackCount}`;
            }
        }

        function formatCurrencyShort(value) {
            if (typeof value !== 'number' || !Number.isFinite(value) || value < 0) return 'N/A';
            if (value >= 1_000_000_000_000) return `$${(value / 1_000_000_000_000).toFixed(2)}T`;
            if (value >= 1_000_000_000) return `$${(value / 1_000_000_000).toFixed(1)}B`;
            if (value >= 1_000_000) return `$${(value / 1_000_000).toFixed(1)}M`;
            return `$${value.toFixed(0)}`;
        }

        function updateDividendCriteriaLabel() {
            const criteriaEl = document.getElementById('dividendCriteriaText');
            if (!criteriaEl) return;
            const map = {
                market_cap_desc: 'Highest Market Cap',
                dividend_amount_desc: 'Highest Dividend Amount',
                turnover_desc: 'Highest Turnover'
            };
            criteriaEl.textContent = `Stocks are sorted by ${map[currentDividendSort] || 'Highest Market Cap'}.`;
        }

        function syncDividendSortButtons() {
            document.querySelectorAll('.dividend-sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === currentDividendSort);
            });
        }

        function normalizeSymbolForBoard(symbol) {
            return String(symbol || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderDividendList(type = 'world') {
            const listEl = document.getElementById('dividendList');
            if (!listEl) return;
            currentDividendTab = type;
            const items = getSortedDividendItems(getActiveDividendItems());

            listEl.innerHTML = items.map((item, index) => {
                const boardSymbol = normalizeSymbolForBoard(item.symbol);
                const regionText = item.region ? ` · ${item.region}` : ' · United States';
                const quote = dividendQuoteCache[getDividendCacheKey(item)] || null;
                const priceText = quote && typeof quote.price === 'number' ? `$${quote.price.toFixed(2)}` : 'N/A';
                const changeText = quote && typeof quote.changePercent === 'number'
                    ? `${quote.changePercent >= 0 ? '+' : ''}${quote.changePercent.toFixed(2)}%`
                    : 'N/A';
                const dividendAmountText = quote && typeof quote.dividendRate === 'number' ? `$${quote.dividendRate.toFixed(2)}` : 'N/A';
                const marketCapText = formatMarketCap(quote?.marketCap);
                const turnoverText = formatCurrencyShort(quote?.turnover);
                return `
                    <li class="dividend-item">
                        <div class="dividend-rank">Rank #${index + 1}</div>
                        <div class="dividend-symbol">${escapeHtml(item.symbol)}</div>
                        <div class="dividend-name">${escapeHtml(item.name)}</div>
                        <div class="dividend-meta">Dividend payer${regionText} · <a class="board-link" href="./symbol.html?symbol=${encodeURIComponent(boardSymbol)}">Symbol Board</a></div>
                        <div class="dividend-live">
                            <span class="dividend-badge">Price ${priceText}</span>
                            <span class="dividend-badge">Change ${changeText}</span>
                            <span class="dividend-badge">Dividend ${dividendAmountText}</span>
                            <span class="dividend-badge">Mkt Cap ${marketCapText}</span>
                            <span class="dividend-badge">Turnover ${turnoverText}</span>
                        </div>
                        <div class="dividend-actions">
                            <input type="number" class="dividend-qty-input" data-symbol="${escapeHtml(item.symbol)}" data-name="${escapeHtml(item.name)}" min="1" step="1" value="1" />
                            <button class="dividend-add-btn" type="button" data-symbol="${escapeHtml(item.symbol)}" data-name="${escapeHtml(item.name)}">Add to Portfolio</button>
                        </div>
                    </li>
                `;
            }).join('');

            updateDividendCriteriaLabel();
            syncDividendSortButtons();
        }

        function renderDividendPortfolio() {
            const body = document.getElementById('dividendPortfolioBody');
            const summary = document.getElementById('dividendPortfolioSummary');
            if (!body || !summary) return;

            const entries = Object.entries(dividendPortfolio);
            if (entries.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="calendar-note">No stocks added yet.</td></tr>';
                summary.textContent = 'Total value: $0.00';
                return;
            }

            let totalValue = 0, totalAnnualDiv = 0;
            body.innerHTML = entries.map(([key, item]) => {
                const cacheKey = `${item.tab}:${item.symbol}`;
                const quote = dividendQuoteCache[cacheKey] || buildDividendFallback(item.symbol);
                const price = typeof quote.price === 'number' ? quote.price : 0;
                const value = price * item.qty;
                const annualDivPerShare = typeof quote.dividendRate === 'number' ? quote.dividendRate : 0;
                const annualDiv = annualDivPerShare * item.qty;
                const monthlyDiv = annualDiv / 12;
                const yieldPct = price > 0 && annualDivPerShare > 0
                    ? ((annualDivPerShare / price) * 100).toFixed(2) + '%'
                    : 'N/A';
                totalValue += value;
                totalAnnualDiv += annualDiv;
                const divStyle = annualDiv > 0 ? 'color:#16a34a;font-weight:700;' : 'color:#94a3b8;';
                return `
                    <tr>
                        <td>${escapeHtml(item.symbol)}</td>
                        <td>${escapeHtml(item.name)}</td>
                        <td><input type="number" min="1" step="1" class="portfolio-qty-input" data-key="${key}" value="${item.qty}" /></td>
                        <td>$${price.toFixed(2)}</td>
                        <td>$${value.toFixed(2)}</td>
                        <td style="${divStyle}">$${annualDiv.toFixed(2)}</td>
                        <td style="${divStyle}">$${monthlyDiv.toFixed(2)}</td>
                        <td>${yieldPct}</td>
                        <td><button class="dividend-remove-btn" type="button" data-key="${key}">Remove</button></td>
                    </tr>
                `;
            }).join('');

            const totalMonthlyDiv = totalAnnualDiv / 12;
            summary.innerHTML = `
                <span>\ubcf4\uc720 \uc885\ubaa9: <b>${entries.length}\uac1c</b></span> &nbsp;|&nbsp;
                <span>\ucd1d \ud3c9\uac00\uae08\uc561: <b>$${totalValue.toFixed(2)}</b></span> &nbsp;|&nbsp;
                <span style="color:#16a34a;">\uc5f0\uac04 \uc608\uc0c1 \ubc30\ub2f9\uae08: <b>$${totalAnnualDiv.toFixed(2)}</b></span> &nbsp;|&nbsp;
                <span style="color:#16a34a;">\uc6d4 \uc608\uc0c1 \ubc30\ub2f9\uae08: <b>$${totalMonthlyDiv.toFixed(2)}</b></span>
            `;
        }

        function bindDividendPortfolioActions() {
            const listEl = document.getElementById('dividendList');
            const body = document.getElementById('dividendPortfolioBody');
            if (!listEl || !body) return;

            listEl.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement) || !target.classList.contains('dividend-add-btn')) return;
                const symbol = target.dataset.symbol;
                const name = target.dataset.name;
                if (!symbol || !name) return;

                const input = listEl.querySelector(`.dividend-qty-input[data-symbol="${symbol}"]`);
                const qty = Math.max(1, parseInt(input?.value || '1', 10) || 1);
                const key = `${currentDividendTab}:${symbol}`;

                if (dividendPortfolio[key]) {
                    dividendPortfolio[key].qty += qty;
                } else {
                    dividendPortfolio[key] = {
                        tab: currentDividendTab,
                        symbol,
                        name,
                        qty
                    };
                }

                saveDividendPortfolio();
                renderDividendPortfolio();
            });

            body.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement) || !target.classList.contains('dividend-remove-btn')) return;
                const key = target.dataset.key;
                if (!key || !dividendPortfolio[key]) return;
                delete dividendPortfolio[key];
                saveDividendPortfolio();
                renderDividendPortfolio();
            });

            body.addEventListener('change', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement) || !target.classList.contains('portfolio-qty-input')) return;
                const key = target.dataset.key;
                const qty = Math.max(1, parseInt(target.value || '1', 10) || 1);
                if (!key || !dividendPortfolio[key]) return;
                dividendPortfolio[key].qty = qty;
                target.value = String(qty);
                saveDividendPortfolio();
                renderDividendPortfolio();
            });
        }

        function bindDividendTabs() {
            const worldBtn = document.getElementById('dividendWorldBtn');
            const usBtn = document.getElementById('dividendUsBtn');
            if (!worldBtn || !usBtn) return;

            worldBtn.addEventListener('click', async () => {
                worldBtn.classList.add('active');
                usBtn.classList.remove('active');
                await updateDividendQuotes();
                renderDividendList('world');
                renderDividendPortfolio();
            });

            usBtn.addEventListener('click', async () => {
                usBtn.classList.add('active');
                worldBtn.classList.remove('active');
                await updateDividendQuotes();
                renderDividendList('us');
                renderDividendPortfolio();
            });
        }

        function bindDividendSort() {
            const sortButtons = document.querySelectorAll('.dividend-sort-btn');
            if (!sortButtons.length) return;
            sortButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const sortKey = button.dataset.sort;
                    if (!sortKey) return;
                    currentDividendSort = sortKey;
                    syncDividendSortButtons();
                    updateDividendCriteriaLabel();
                    renderDividendList(currentDividendTab);
                });
            });
            syncDividendSortButtons();
            updateDividendCriteriaLabel();
        }

        const US_ECONOMIC_EVENTS = {
            '2026-02-27': [
                { title: 'Core PCE Price Index (MoM)', impact: 'high' },
                { title: 'Personal Income / Spending', impact: 'medium' }
            ],
            '2026-03-06': [
                { title: 'Non-Farm Payrolls', impact: 'high' },
                { title: 'Unemployment Rate', impact: 'high' }
            ],
            '2026-03-11': [
                { title: 'CPI (YoY / MoM)', impact: 'high' }
            ],
            '2026-03-12': [
                { title: 'PPI (YoY / MoM)', impact: 'medium' },
                { title: 'Initial Jobless Claims', impact: 'medium' }
            ],
            '2026-03-17': [
                { title: 'Retail Sales', impact: 'high' },
                { title: 'Industrial Production', impact: 'medium' }
            ],
            '2026-03-18': [
                { title: 'FOMC Rate Decision', impact: 'high' },
                { title: 'Fed Economic Projections', impact: 'high' }
            ],
            '2026-03-19': [
                { title: 'Initial Jobless Claims', impact: 'medium' },
                { title: 'Existing Home Sales', impact: 'low' }
            ],
            '2026-03-26': [
                { title: 'GDP (Final, QoQ)', impact: 'high' },
                { title: 'Durable Goods Orders', impact: 'medium' }
            ],
            '2026-03-27': [
                { title: 'Core PCE Price Index', impact: 'high' },
                { title: 'University of Michigan Sentiment', impact: 'low' }
            ],
            '2026-03-31': [
                { title: 'CB Consumer Confidence', impact: 'medium' }
            ]
        };

        let delayedQuotes = {};
        const MARKET_CACHE_KEY = 'market_quote_cache_v1';

        function loadMarketCache() {
            try {
                const raw = localStorage.getItem(MARKET_CACHE_KEY);
                const parsed = JSON.parse(raw || '{}');
                const restored = {};
                Object.entries(parsed || {}).forEach(([symbol, q]) => {
                    if (!q || typeof q.price !== 'number') return;
                    restored[symbol] = {
                        price: Number(q.price),
                        prevClose: typeof q.prevClose === 'number' ? Number(q.prevClose) : Number(q.price),
                        time: q.time ? new Date(q.time) : new Date()
                    };
                });
                return restored;
            } catch {
                return {};
            }
        }

        function saveMarketCache(quotesBySymbol) {
            try {
                const serializable = {};
                Object.entries(quotesBySymbol || {}).forEach(([symbol, q]) => {
                    if (!q || typeof q.price !== 'number') return;
                    serializable[symbol] = {
                        price: Number(q.price),
                        prevClose: typeof q.prevClose === 'number' ? Number(q.prevClose) : Number(q.price),
                        time: q.time instanceof Date ? q.time.toISOString() : new Date().toISOString()
                    };
                });
                localStorage.setItem(MARKET_CACHE_KEY, JSON.stringify(serializable));
            } catch {
            }
        }

        function buildFallbackQuote(symbol, base) {
            const now = new Date();
            const phase = Math.floor(Date.now() / 600000);
            const seed = symbol.length * 31 + symbol.charCodeAt(0);
            const wave = Math.sin((phase + seed) * 0.31) * 0.0028 + Math.cos((phase + seed) * 0.17) * 0.0019;
            const price = Number((base * (1 + wave)).toFixed(2));
            return {
                price,
                prevClose: Number(base.toFixed(2)),
                time: now
            };
        }

        async function fetchDelayedQuotes() {
            const pairs = Object.entries(DELAYED_QUOTE_SYMBOLS);
            const yahooList = pairs.map(([, yahoo]) => yahoo).join(',');
            const response = await fetch(`/api/quote?symbols=${encodeURIComponent(yahooList)}`);
            if (!response.ok) throw new Error('Delayed quote HTTP error');
            const data = await response.json();
            const results = data?.quoteResponse?.result;
            if (!Array.isArray(results)) throw new Error('Delayed quote payload error');

            const reverseMap = {};
            pairs.forEach(([appSymbol, yahooSymbol]) => {
                reverseMap[yahooSymbol] = appSymbol;
            });

            const next = {};
            results.forEach(item => {
                const appSymbol = reverseMap[item.symbol];
                if (!appSymbol) return;
                if (typeof item.regularMarketPrice !== 'number') return;
                next[appSymbol] = {
                    price: Number(item.regularMarketPrice),
                    prevClose: typeof item.regularMarketPreviousClose === 'number' ? Number(item.regularMarketPreviousClose) : null,
                    time: typeof item.regularMarketTime === 'number' ? new Date(item.regularMarketTime * 1000) : new Date()
                };
            });

            delayedQuotes = next;
        }

        function getTargetMonth(today = new Date()) {
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const remainDays = endOfMonth - today.getDate();
            if (remainDays < 7) {
                return new Date(today.getFullYear(), today.getMonth() + 1, 1);
            }
            return firstDayOfMonth;
        }

        function renderEconomicCalendar() {
            const grid = document.getElementById('economicCalendarGrid');
            const monthLabel = document.getElementById('calendarMonthLabel');
            if (!grid || !monthLabel) return;

            const target = getTargetMonth();
            const year = target.getFullYear();
            const month = target.getMonth();
            const monthName = target.toLocaleString('en-US', { month: 'long' });
            monthLabel.textContent = `${monthName} ${year} (Expected U.S. Economic Releases)`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const weekHeads = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = '';
            weekHeads.forEach(day => {
                html += `<div class="calendar-day-head">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-cell empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = US_ECONOMIC_EVENTS[key] || [];
                const eventsHtml = events.map(evt => {
                    const impactClass = evt.impact === 'high' ? 'event-high' : (evt.impact === 'medium' ? 'event-medium' : 'event-low');
                    const impactText = evt.impact === 'high' ? 'High' : (evt.impact === 'medium' ? 'Medium' : 'Low');
                    return `<div class="event-item ${impactClass}">${evt.title} · ${impactText}</div>`;
                }).join('');

                html += `<div class="calendar-cell"><div class="calendar-day-num">${day}</div>${eventsHtml}</div>`;
            }

            const rows = Math.ceil((firstDay + daysInMonth) / 7);
            const totalCells = rows * 7;
            const trailing = totalCells - (firstDay + daysInMonth);
            for (let i = 0; i < trailing; i++) {
                html += '<div class="calendar-cell empty"></div>';
            }

            grid.innerHTML = html;
        }

        function formatChangePercent(deltaPercent) {
            const sign = deltaPercent >= 0 ? '+' : '';
            return `${sign}${deltaPercent.toFixed(2)}%`;
        }

        async function updateMarketData() {
            const markets = [
                { id: 'sp500', base: 5150.44 },
                { id: 'nasdaq', base: 16520.22 },
                { id: 'dow', base: 38800.10 },
                { id: 'kospi', base: 2580.12 },
                { id: 'kosdaq', base: 865.34 },
                { id: 'aapl', base: 187.22 }
            ];

            let usedDelayed = false;
            try {
                await fetchDelayedQuotes();
                usedDelayed = Object.keys(delayedQuotes).length > 0;
            } catch {
                usedDelayed = false;
            }

            const cachedQuotes = loadMarketCache();
            const nextCache = { ...cachedQuotes };
            let delayedCount = 0;

            markets.forEach(market => {
                const symbol = MARKET_ID_TO_SYMBOL[market.id] || market.id.toUpperCase();
                const delayed = delayedQuotes[symbol] || null;
                const quote = delayed || cachedQuotes[symbol] || buildFallbackQuote(symbol, market.base);

                if (delayed) delayedCount += 1;
                if (quote) nextCache[symbol] = quote;

                const price = quote?.price ?? market.base;
                const prevPrice = quote?.prevClose && quote.prevClose !== 0 ? quote.prevClose : market.base;
                const deltaPercent = price != null && prevPrice != null && prevPrice !== 0
                    ? ((price - prevPrice) / prevPrice) * 100
                    : null;
                const isPositive = deltaPercent >= 0;

                document.getElementById(`${market.id}-price`).textContent = `$${price.toFixed(2)}`;
                document.getElementById(`${market.id}-change`).textContent = deltaPercent == null ? '+0.00%' : formatChangePercent(deltaPercent);
                document.getElementById(`${market.id}-change`).className = `market-change ${deltaPercent == null ? '' : (isPositive ? 'change-positive' : 'change-negative')}`;
                document.getElementById(`${market.id}-time`).textContent = (quote?.time instanceof Date ? quote.time : new Date()).toLocaleTimeString();
            });

            saveMarketCache(nextCache);

            const note = document.getElementById('marketDataNote');
            if (note) {
                note.textContent = usedDelayed
                    ? `Displayed data: Yahoo Finance delayed quotes (free, usually ~15 min delay) · Missing items fallback to cache/base index (${delayedCount}/${markets.length} received)`
                    : 'Displayed data: delayed quotes unavailable · showing cache/base index values';
            }
        }

        async function refreshData() {
            await updateMarketData();
            await updateDividendQuotes();
            renderDividendList(currentDividendTab);
            renderDividendPortfolio();
            alert('Data refresh complete');
        }

        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.textContent = '&#9728;&#65039; Light Mode';
        }

        themeToggle.addEventListener('click', function() {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.textContent = isDark ? '&#9728;&#65039; Light Mode' : '&#127769; Dark Mode';
        });

        window.addEventListener('load', async function() {
            loadDividendPortfolio();
            bindDividendTabs();
            bindDividendSort();
            bindDividendPortfolioActions();
            await updateDividendQuotes();
            renderDividendList('world');
            renderDividendPortfolio();
            renderEconomicCalendar();
            await updateMarketData();
            setInterval(updateMarketData, 60000);
            setInterval(async () => {
                await updateDividendQuotes();
                renderDividendList(currentDividendTab);
                renderDividendPortfolio();
            }, 120000);
        });
    </script>
    <script src="./analytics.js"></script>
    <script src="./legal-consent.js"></script>
    <script src="./assistant-widget.js"></script>
    <script src="./userback.js"></script>
    <script src="./global-theme.js"></script>
<script src="./nav-auth.js"></script>
</body>
</html>

