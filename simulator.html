<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulator - Smart Investment Tips</title>
    <link rel="stylesheet" href="./index.html" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', sans-serif; background:#f8f9fa; color:#222; }
        nav { background:white; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        nav .container{ max-width:1200px; margin:0 auto; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
        .container{ max-width:1200px; margin:0 auto; padding:20px; }
        h1{ font-size:28px; margin-bottom:8px }
        .sim-grid{ display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start }
        .panel{ background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
        .small{ font-size:13px; color:#666 }
        .controls{ display:flex; gap:8px; margin-bottom:12px }
        input, select, button{ padding:8px 10px; border-radius:6px; border:1px solid #ddd }
        table{ width:100%; border-collapse:collapse; margin-top:12px }
        th,td{ text-align:left; padding:8px; border-bottom:1px solid #f1f1f1 }
        .positive{ color:green } .negative{ color:red }
        canvas{ width:100% !important; height:260px !important }
        .footer-note{ margin-top:14px; font-size:13px; color:#666 }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <div class="logo">üí∞ Smart Investment Tips</div>
            <div><a href="./index.html">Home</a> ‚Ä¢ <a href="./market.html">Markets</a> ‚Ä¢ <a href="./journal.html">Journal</a> ‚Ä¢ <a href="./auth.html">Login</a> ‚Ä¢ Simulator</div>
        </div>
    </nav>

    <div class="container">
        <h1>Virtual Trading Simulator</h1>
        <p class="small">Practice trading with demo prices only. No real money involved. Portfolio and history are stored per logged-in account.</p>
        <p class="small" id="authStatus">Checking login status...</p>

        <div class="sim-grid">
            <div>
                <div class="panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                        <div>
                            <div class="small">Starting Cash</div>
                            <div style="font-size:20px; font-weight:700" id="cashDisplay">$100,000.00</div>
                        </div>
                        <div>
                            <div class="small">Portfolio Value</div>
                            <div style="font-size:20px; font-weight:700" id="portfolioValue">$100,000.00</div>
                        </div>
                    </div>

                    <div style="margin-bottom:10px" class="small">Search symbol (e.g. AAPL, MSFT, 005930.KS)</div>
                    <div class="controls">
                        <input id="symbolInput" placeholder="Enter symbol" />
                        <button id="lookupBtn">Lookup</button>
                    </div>

                    <div id="quoteBox" style="display:none; margin-bottom:12px">
                        <div class="small">Symbol: <span id="qSymbol"></span></div>
                        <div style="font-size:22px; font-weight:700" id="qPrice">$0.00</div>
                        <div class="small">Change: <span id="qChange"></span></div>
                    </div>

                    <div style="display:flex; gap:8px; margin-bottom:8px">
                        <input id="qtyInput" type="number" min="1" placeholder="Qty" />
                        <select id="actionSelect"><option value="buy">Buy</option><option value="sell">Sell</option></select>
                        <button id="tradeBtn">Execute Trade</button>
                    </div>

                    <div style="display:flex; gap:8px; margin-top:6px">
                        <button id="resetBtn" style="background:#f8d7da; border:1px solid #f5c6cb">Reset Portfolio</button>
                        <button id="exportBtn">Export</button>
                        <button id="importBtn">Import</button>
                        <input id="importFile" type="file" style="display:none" />
                    </div>

                    <h3 style="margin-top:18px">Holdings</h3>
                    <div style="overflow:auto; max-height:220px">
                        <table id="holdingsTable"><thead><tr><th>Symbol</th><th>Qty</th><th>Avg</th><th>Current</th><th>PL</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>

                <div class="panel" style="margin-top:18px">
                    <h3>Transaction History</h3>
                    <div style="overflow:auto; max-height:220px">
                        <table id="txTable"><thead><tr><th>Date</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <div>
                <div class="panel">
                    <h3>Portfolio Performance</h3>
                    <canvas id="perfChart"></canvas>
                    <div class="footer-note">Chart updates when trades are executed or data refreshed.</div>
                </div>
                
                <div class="panel" style="margin-top:18px">
                    <h3>Notes & Limits</h3>
                    <p class="small">This simulator uses demo prices only (no external API). Data stored only in your browser.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const initialCash = 100000;

        const authStatus = document.getElementById('authStatus');
        const supabaseUrl = localStorage.getItem('supabase_url');
        const supabaseAnonKey = localStorage.getItem('supabase_anon_key');
        const supabaseClient = (supabaseUrl && supabaseAnonKey)
            ? window.supabase.createClient(supabaseUrl, supabaseAnonKey)
            : null;
        let currentUser = null;

        // State
        let cash = initialCash;
        let portfolio = {};
        let txs = [];
        let perf = [];

        const cashDisplay = document.getElementById('cashDisplay');
        const portfolioValueEl = document.getElementById('portfolioValue');
        const holdingsTbody = document.querySelector('#holdingsTable tbody');
        const txTbody = document.querySelector('#txTable tbody');
        const qBox = document.getElementById('quoteBox');

        async function saveState(){
            if (!supabaseClient || !currentUser) return;
            await supabaseClient.from('virtual_accounts').upsert({
                user_id: currentUser.id,
                cash,
                portfolio,
                perf,
                updated_at: new Date().toISOString()
            });
        }

        async function addTradeRecord(side, sym, qty, price){
            if (!supabaseClient || !currentUser) return;
            await supabaseClient.from('virtual_trades').insert({
                user_id: currentUser.id,
                symbol: sym,
                side,
                qty,
                price
            });
        }

        async function loadRemoteState(){
            if (!supabaseClient || !currentUser) return;

            const { data: account } = await supabaseClient
                .from('virtual_accounts')
                .select('*')
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (!account) {
                await supabaseClient.from('virtual_accounts').insert({
                    user_id: currentUser.id,
                    cash: initialCash,
                    portfolio: {},
                    perf: []
                });
                cash = initialCash;
                portfolio = {};
                perf = [];
            } else {
                cash = Number(account.cash ?? initialCash);
                portfolio = account.portfolio || {};
                perf = account.perf || [];
            }

            const { data: tradeRows } = await supabaseClient
                .from('virtual_trades')
                .select('symbol, side, qty, price, created_at')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(300);

            txs = (tradeRows || []).map(row => ({
                date: new Date(row.created_at).toLocaleString(),
                symbol: row.symbol,
                side: row.side,
                qty: row.qty,
                price: Number(row.price)
            }));
        }

        function format(n){ return typeof n==='number' ? n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : n }

        function render(){
            cashDisplay.textContent = '$' + format(cash);
            // render holdings
            holdingsTbody.innerHTML = '';
            let total = cash;
            const symbols = Object.keys(portfolio);
            if(symbols.length===0){
                holdingsTbody.innerHTML = '<tr><td colspan="5" class="small">No holdings</td></tr>';
            }
            symbols.forEach(sym => {
                const it = portfolio[sym];
                const cur = it.currentPrice || it.avgPrice; // fallback
                const pl = (cur - it.avgPrice) * it.qty;
                total += cur * it.qty;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${sym}</td><td>${it.qty}</td><td>$${format(it.avgPrice)}</td><td>$${format(cur)}</td><td class="${pl>=0? 'positive':'negative'}">$${format(pl)}</td>`;
                holdingsTbody.appendChild(tr);
            });
            portfolioValueEl.textContent = '$' + format(total);

            // tx history
            txTbody.innerHTML = '';
            if(txs.length===0){ txTbody.innerHTML = '<tr><td colspan="5" class="small">No transactions</td></tr>' }
            txs.forEach(t=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${t.date}</td><td>${t.symbol}</td><td>${t.side}</td><td>${t.qty}</td><td>$${format(t.price)}</td>`;
                txTbody.appendChild(tr);
            });
            updatePerf(total);
        }

        const demoPrices = {};

        function symbolSeed(symbol) {
            let hash = 0;
            for (let i = 0; i < symbol.length; i++) {
                hash = ((hash << 5) - hash) + symbol.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function getDemoPrice(symbol) {
            if (!demoPrices[symbol]) {
                const seed = symbolSeed(symbol);
                demoPrices[symbol] = 10 + (seed % 490) + (seed % 97) / 100;
            }
            const drift = (Math.random() - 0.5) * 0.8;
            demoPrices[symbol] = Math.max(1, demoPrices[symbol] + drift);
            return demoPrices[symbol];
        }

        function lookup(symbol){
            const elSym = document.getElementById('qSymbol');
            const elPrice = document.getElementById('qPrice');
            const elChange = document.getElementById('qChange');
            qBox.style.display='none';
            elSym.textContent = symbol;

            const price = getDemoPrice(symbol);
            const change = ((Math.random() - 0.5) * 2).toFixed(2) + '%';

            elPrice.textContent = '$' + format(price);
            elChange.textContent = change;
            qBox.style.display='block';
            return {symbol, price};
        }

        function fetchPrice(symbol){
            return getDemoPrice(symbol);
        }

        async function executeTrade(){
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. auth.htmlÏóêÏÑú Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.');
                return;
            }
            const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
            const qty = parseInt(document.getElementById('qtyInput').value,10);
            const side = document.getElementById('actionSelect').value;
            if(!sym || !qty || qty<=0){ alert('Enter valid symbol and qty'); return }
            const price = fetchPrice(sym);
            if(price===null){ alert('Price not available'); return }

            if(side==='buy'){
                const cost = price * qty;
                if(cost > cash){ alert('Insufficient cash'); return }
                cash -= cost;
                if(!portfolio[sym]) portfolio[sym] = { qty:0, avgPrice:0, currentPrice:price };
                const existing = portfolio[sym];
                const newQty = existing.qty + qty;
                existing.avgPrice = ((existing.avgPrice * existing.qty) + (price * qty)) / newQty;
                existing.qty = newQty;
                existing.currentPrice = price;
                const t = { date:new Date().toLocaleString(), symbol: sym, side:'BUY', qty, price };
                txs.unshift(t);
                await addTradeRecord('BUY', sym, qty, price);
            } else {
                if(!portfolio[sym] || portfolio[sym].qty < qty){ alert('Not enough shares to sell'); return }
                const proceeds = price * qty;
                cash += proceeds;
                portfolio[sym].qty -= qty;
                portfolio[sym].currentPrice = price;
                if(portfolio[sym].qty===0) delete portfolio[sym];
                const t = { date:new Date().toLocaleString(), symbol: sym, side:'SELL', qty, price };
                txs.unshift(t);
                await addTradeRecord('SELL', sym, qty, price);
            }
            await saveState();
            render();
        }

        async function resetPortfolio(){
            if(!confirm('Reset portfolio and transactions?')) return;
            cash = initialCash; portfolio = {}; txs = []; perf = [];
            if (supabaseClient && currentUser) {
                await supabaseClient.from('virtual_trades').delete().eq('user_id', currentUser.id);
                await saveState();
            }
            render();
        }

        function exportState(){
            const data = { cash, portfolio, txs, perf };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'simulator_export.json'; document.body.appendChild(a); a.click(); a.remove();
        }

        function importStateFile(file){
            const reader = new FileReader();
            reader.onload = e=>{
                try{
                    const data = JSON.parse(e.target.result);
                    cash = parseFloat(data.cash) || initialCash;
                    portfolio = data.portfolio || {};
                    txs = data.txs || [];
                    perf = data.perf || [];
                    saveState(); render();
                    alert('Import successful');
                }catch(err){ alert('Invalid file') }
            };
            reader.readAsText(file);
        }

        // Performance chart
        let perfChart;
        function updatePerf(currentTotal){
            const now = new Date().toLocaleString();
            perf.push({ t: now, v: currentTotal });
            if(perf.length>60) perf.shift();
            renderPerf();
        }

        function renderPerf(){
            const labels = perf.map(p=>p.t);
            const data = perf.map(p=>p.v);
            if(!perfChart){
                const ctx = document.getElementById('perfChart').getContext('2d');
                perfChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Portfolio Value', data, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.12)', tension:0.3 }] }, options:{ maintainAspectRatio:false } });
            } else {
                perfChart.data.labels = labels; perfChart.data.datasets[0].data = data; perfChart.update();
            }
        }

        // bind
        document.getElementById('lookupBtn').addEventListener('click', ()=>{
            const s = document.getElementById('symbolInput').value.trim(); if(!s) return; lookup(s);
        });
        document.getElementById('tradeBtn').addEventListener('click', executeTrade);
        document.getElementById('resetBtn').addEventListener('click', resetPortfolio);
        document.getElementById('exportBtn').addEventListener('click', exportState);
        document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', e=>{ if(e.target.files.length) importStateFile(e.target.files[0]); });

        async function initAuthAndData() {
            if (!supabaseClient) {
                authStatus.innerHTML = 'Supabase ÏÑ§Ï†ïÏù¥ ÏóÜÏäµÎãàÎã§. <a href="./auth.html">auth.html</a>ÏóêÏÑú URL/KeyÎ•º Ï†ÄÏû•ÌïòÏÑ∏Ïöî.';
                document.getElementById('tradeBtn').disabled = true;
                return;
            }

            const { data } = await supabaseClient.auth.getSession();
            if (!data?.session?.user) {
                authStatus.innerHTML = 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. <a href="./auth.html">Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ</a>';
                document.getElementById('tradeBtn').disabled = true;
                return;
            }

            currentUser = data.session.user;
            authStatus.textContent = `Logged in: ${currentUser.email}`;
            await loadRemoteState();
            render();
            renderPerf();
        }

        // initial load
        window.addEventListener('load', initAuthAndData);
    </script>
</body>
</html>
