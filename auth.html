<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Sign Up - Smart Investment Tips</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', sans-serif; background: #f6f7fb; color: #111827; }
        .wrap { max-width: 520px; margin: 48px auto; padding: 0 16px; }
        .card { background: #fff; border-radius: 14px; padding: 20px; box-shadow: 0 10px 22px rgba(15, 23, 42, .08); margin-bottom: 14px; }
        h1 { margin: 0 0 8px; font-size: 26px; }
        p { margin: 0 0 14px; color: #6b7280; font-size: 14px; }
        label { display: block; font-size: 13px; color: #6b7280; margin: 10px 0 6px; }
        input, button { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; font-size: 14px; }
        button { background: #2563eb; color: #fff; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .ghost { background: #fff; color: #111827; border: 1px solid #d1d5db; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .helper { font-size: 12px; color: #6b7280; margin-top: 8px; }
        .status { font-size: 13px; margin-top: 10px; color: #1d4ed8; }
        a { color: #2563eb; text-decoration: none; }
        .agree-wrap { margin-top: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f9fafb; }
        .agree-row { display: flex; gap: 8px; align-items: flex-start; font-size: 13px; color: #374151; }
        .agree-row input { width: auto; margin-top: 2px; }
        #supabaseConfigPanel { display: none; }
    </style>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vmylxac7pb");
</script>
</head>
<body>
    <div class="wrap">
        <div class="card" id="supabaseConfigPanel">
            <h1>Login / Sign Up</h1>
            <p>An account is required to save your personal virtual portfolio and trade history.</p>
            <div class="helper">Configured URL/keys are stored in your browser.</div>

            <label for="supabaseUrl">Supabase URL</label>
            <input id="supabaseUrl" placeholder="https://xxxx.supabase.co" />

            <label for="supabaseAnonKey">Supabase Anon Key</label>
            <input id="supabaseAnonKey" placeholder="eyJ..." />

            <button id="saveConfigBtn" class="ghost">Save Supabase Settings</button>
            <div id="configStatus" class="status"></div>
        </div>

        <div class="card">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" />

            <label for="nickname">Nickname</label>
            <input id="nickname" type="text" placeholder="Nickname (2-20 chars)" />

            <label for="password">Password</label>
            <input id="password" type="password" placeholder="At least 8 characters" />

            <label for="verifyCode">Verification Code</label>
            <input id="verifyCode" type="text" placeholder="8-digit code from your email" />

            <button id="sendCodeBtn" class="ghost">Send Verification Code</button>

            <div class="row">
                <button id="signUpBtn">Verify Code & Sign Up</button>
                <button id="signInBtn" class="ghost">Login</button>
            </div>
            <div class="agree-wrap">
                <label class="agree-row" for="agreeRequired" style="margin:0;">
                    <input id="agreeRequired" type="checkbox" />
                    <span>[Required] I agree to the <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="./terms.html" target="_blank" rel="noopener">Terms of Service</a>.</span>
                </label>
                <label class="agree-row" for="agreeCommunity" style="margin:8px 0 0 0;">
                    <input id="agreeCommunity" type="checkbox" />
                    <span>[Required] I agree to the <a href="./community-rules.html" target="_blank" rel="noopener">Community Rules</a> (no personal ads/sexual content; violations may result in a ban).</span>
                </label>
            </div>
            <button id="resendBtn" class="ghost">Resend Verification Email</button>
            <div id="authStatus" class="status"></div>
            <div class="helper">Sign-up flow: send code → enter code → check required agreements → click sign-up.</div>
            <div class="helper"><a href="./index.html">Back to Home</a> · <a href="./contact.html">Contact</a></div>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('supabaseUrl');
        const keyInput = document.getElementById('supabaseAnonKey');
        const configStatus = document.getElementById('configStatus');
        const authStatus = document.getElementById('authStatus');
        const LOCAL_USERS_KEY = 'local_auth_users_v1';
        const LOCAL_SESSION_KEY = 'local_auth_session_v1';

        if (urlInput) urlInput.value = localStorage.getItem('supabase_url') || '';
        if (keyInput) keyInput.value = localStorage.getItem('supabase_anon_key') || '';

        function getClient() {
            const supabaseUrl = localStorage.getItem('supabase_url');
            const supabaseAnonKey = localStorage.getItem('supabase_anon_key');
            if (!supabaseUrl || !supabaseAnonKey) return null;
            return window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        }

        function getLocalUsers() {
            return JSON.parse(localStorage.getItem(LOCAL_USERS_KEY) || '[]');
        }

        function setLocalUsers(users) {
            localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(users));
        }

        async function sendSignupCode(client, email) {
            return await client.auth.signInWithOtp({
                email,
                options: {
                    shouldCreateUser: true
                }
            });
        }

        document.getElementById('saveConfigBtn')?.addEventListener('click', () => {
            const supabaseUrl = urlInput.value.trim();
            const supabaseAnonKey = keyInput.value.trim();
            if (!supabaseUrl || !supabaseAnonKey) {
                configStatus.textContent = 'Please enter both URL and Anon Key.';
                return;
            }
            localStorage.setItem('supabase_url', supabaseUrl);
            localStorage.setItem('supabase_anon_key', supabaseAnonKey);
            configStatus.textContent = 'Saved.';
        });

        document.getElementById('sendCodeBtn').addEventListener('click', async () => {
            const client = getClient();
            const email = document.getElementById('email').value.trim();

            if (!email) {
                authStatus.textContent = 'Please enter your email.';
                return;
            }

            if (!client) {
                authStatus.textContent = 'Supabase configuration is required for code-based sign-up.';
                return;
            }

            const { error } = await sendSignupCode(client, email);
            authStatus.textContent = error ? ('Code send failed: ' + error.message) : 'Verification code sent. Please check your email.';
        });

        document.getElementById('signUpBtn').addEventListener('click', async () => {
            const client = getClient();
            const email = document.getElementById('email').value.trim();
            const nickname = document.getElementById('nickname').value.trim();
            const password = document.getElementById('password').value;
            const verifyCode = document.getElementById('verifyCode').value.trim();
            const agreeRequired = document.getElementById('agreeRequired').checked;
            const agreeCommunity = document.getElementById('agreeCommunity').checked;

            if (!email || !password || !verifyCode) {
                authStatus.textContent = 'Please enter email, password, and 8-digit verification code.';
                return;
            }

            if (!nickname || nickname.length < 2 || nickname.length > 20) {
                authStatus.textContent = 'Nickname must be 2-20 characters.';
                return;
            }

            if (!/^\d{8}$/.test(verifyCode)) {
                authStatus.textContent = 'Verification code must be 8 digits.';
                return;
            }

            if (!agreeRequired) {
                authStatus.textContent = 'You must agree to Privacy Policy and Terms to sign up.';
                return;
            }

            if (!agreeCommunity) {
                authStatus.textContent = 'You must agree to Community Rules to sign up.';
                return;
            }

            if (!client) {
                authStatus.textContent = 'Supabase configuration is required for code-based sign-up.';
                return;
            }

            const { error: verifyError } = await client.auth.verifyOtp({
                email,
                token: verifyCode,
                type: 'email'
            });

            if (verifyError) {
                authStatus.textContent = 'Code verification failed: ' + verifyError.message;
                return;
            }

            const { error: updateError } = await client.auth.updateUser({
                password,
                data: {
                    nickname,
                    terms_agreed_at: new Date().toISOString(),
                    terms_version: '2026-02-24',
                    community_rules_agreed_at: new Date().toISOString(),
                    community_rules_version: '2026-02-24'
                }
            });
            if (updateError) {
                authStatus.textContent = 'Sign-up finalization failed: ' + updateError.message;
                return;
            }

            localStorage.setItem('profile_nickname', nickname);
            authStatus.textContent = 'Sign-up complete. Redirecting to home...';
            setTimeout(() => {
                location.href = './index.html';
            }, 800);
        });

        document.getElementById('signInBtn').addEventListener('click', async () => {
            const client = getClient();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                authStatus.textContent = 'Please enter email and password.';
                return;
            }

            if (!client) {
                const users = getLocalUsers();
                const matched = users.find(u => u.email === email && u.password === password);
                if (!matched) {
                    authStatus.textContent = 'Local login failed: check email/password.';
                    return;
                }
                localStorage.setItem(LOCAL_SESSION_KEY, email);
                authStatus.textContent = 'Local login successful (using without Supabase).';
                return;
            }

            const { data, error } = await client.auth.signInWithPassword({ email, password });
            if (error) {
                authStatus.textContent = 'Login failed: ' + error.message;
                return;
            }

            const loginNickname = data?.user?.user_metadata?.nickname || '';
            if (loginNickname) {
                localStorage.setItem('profile_nickname', loginNickname);
            }

            if (!data?.user?.email_confirmed_at) {
                await client.auth.signOut();
                authStatus.textContent = 'Please verify your email before logging in.';
                return;
            }

            authStatus.textContent = 'Login successful.';
        });

        document.getElementById('resendBtn').addEventListener('click', async () => {
            const client = getClient();
            if (!client) {
                authStatus.textContent = 'Supabase configuration is required for code-based sign-up.';
                return;
            }
            const email = document.getElementById('email').value.trim();
            if (!email) { authStatus.textContent = 'Please enter your email.'; return; }

            const { error } = await sendSignupCode(client, email);
            authStatus.textContent = error ? ('Code resend failed: ' + error.message) : 'Verification code resent.';
        });

        document.getElementById('signOutBtn')?.addEventListener('click', async () => {
            const client = getClient();
            if (!client) {
                localStorage.removeItem(LOCAL_SESSION_KEY);
                authStatus.textContent = 'Local logout complete.';
                return;
            }
            await client.auth.signOut();
            authStatus.textContent = 'Logout complete.';
        });

        (async () => {
            const client = getClient();
            if (!client) {
                const email = localStorage.getItem(LOCAL_SESSION_KEY);
                if (email) {
                    authStatus.textContent = 'Current local session: ' + email;
                } else {
                    authStatus.textContent = 'Local mode available: sign-up/login possible without Supabase URL.';
                }
                return;
            }

            const { data } = await client.auth.getSession();
            if (data?.session?.user?.email) {
                if (!data.session.user.email_confirmed_at) {
                    authStatus.textContent = 'Current session is unverified. Please verify email and log in again.';
                } else {
                    authStatus.textContent = 'Currently logged in: ' + data.session.user.email;
                }
            }
        })();
    </script>
    <script src="./analytics.js"></script>
    <script src="./legal-consent.js"></script>
    <script src="./assistant-widget.js"></script>
</body>
</html>
